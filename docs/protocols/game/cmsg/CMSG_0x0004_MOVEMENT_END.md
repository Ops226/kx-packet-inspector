# CMSG_MOVEMENT_END (0x0004)

**Direction**: Client -> Server
**Status**: Confirmed (Schema-Driven, Live-Validated)

## Summary

This packet is sent by the client when the player character stops moving. It is the counterpart to `CMSG_0x000B_MOVEMENT_WITH_ROTATION`. It is a complex, schema-driven packet with a large, variable-size payload that communicates the player's final position and state to the server.

## Construction Chain

This packet is generated by the same unified player-action pipeline as other complex movement packets.

1.  **Data Aggregation (`FUN_1410225DE`):** The same high-level aggregator function that handles movement-with-rotation is called, but with parameters indicating the movement has ended. It gathers the player's final position and state.
2.  **Generic Builder Chain:** The aggregator calls down the standard chain of generic builders.
3.  **Serialization (`CMSG::BuildAndSendPacket`):** The final builder calls the main serialization engine, which uses the schema for opcode `0x0004` to build the packet.
4.  **Sending Mechanism (Buffered Stream):** The packet is written to the main `MsgSendContext` buffer and sent in a batch when `MsgConn::FlushPacketBuffer` is called.

## Schema Information

- **Opcode:** `0x0004`
- **Schema Address (Live):** `0x7FF6E0EA0D00`

## Packet Structure (from Schema)

The schema for this packet is complex, containing multiple nested structures and optional blocks, which accounts for the large 86-byte size of live packets. It is structurally very similar to the schema for `0x000B`.

| Field Order | Type | Name | Notes |
|---|---|---|---|
| 1 | `short` | field_0 | Typecode: 0x01 |
| 2 | Small Array | field_1 | Typecode: 0x11 |
| 3 | Compressed `int` | field_2 | Typecode: 0x04 |
| 4 | `byte` | field_3 | Typecode: 0x02 |
| 5 | Optional Block | field_4 | Typecode: 0x0F |
| 6 | `short` | field_5 | Typecode: 0x01 |
| 7 | Small Array | field_6 | Typecode: 0x11 |
| 8 | Compressed `int` | field_7 | Typecode: 0x04 |
| 9 | `byte` | field_8 | Typecode: 0x02 |
| 10 | Optional Block | field_9 | Typecode: 0x0F |
| 11 | `short` | field_10 | Typecode: 0x01 |
| 12 | `long long` | field_11 | Typecode: 0x05 |

## Live Packet Sample (Size 86 bytes)
`16:15:43.370 [S] CMSG_MOVEMENT_END Op:0x0004 | Sz:86 | 04 00 9B 00 91 ED 04 40 01 90 51 68 43 9B 45 9B 41 23 F5 01 42 43 60 08 3C 00 01 80 63 12 C1 ...`