# SMSG 0x0041 — Array Install/Refresh

Status: Confirmed (code-backed)

Dispatch Path:
- Dispatcher: FUN_14025DA50, case 0x41 (index = opcode − 0x2B)
- Schema: &DAT_1425140E0 → passed to FUN_140FD4D50 (typed arg builder)
- Handler code slice (addresses approximate): 0x14025E52A..0x14025E63F

Behavior Summary:
- Parses tuple via FUN_140FD4D50(&DAT_1425140E0) → RBX.
- Resolves/creates a target container from param_1 (typical table at +0x128).
- Iterates an array described by the schema:
  • Reads a count and a pointer to the first element.
  • For each element, performs a keyed lookup/construct and installs or refreshes an entry via a dedicated helper (e.g., FUN_14025D280/FUN_1402581B0 pattern).
- Optional metadata updates per installed entry (e.g., writing specific u32/u8 lanes), then finalizes.

Key Instructions (evidence):
- tuple = FUN_140FD4D50(&DAT_1425140E0)
- tbl = FUN_140257E70(param_1 + 0x128, (ulonglong*)(RBX + 0x02)); if (!tbl) tbl = FUN_1402541C0(param_1 + 0x128, …)
- count = *(u8/u16*)(RBX + COUNT_OFF); elems = *(ElemType**)(RBX + PTR_OFF)
- for (i in 0..count-1):
  • elem = elems[i]
  • rec = FUN_14025D280 or similar installer using elem’s key fields
  • write rec metadata/flags from elem fields when present

Field Layout (from handler access patterns):
- +0x02: key used to resolve/create the container
- COUNT_OFF: u8/u16 element count (depends on 0x11 vs 0x12 schema)
- PTR_OFF: pointer to first element (schema-provided)
- Element layout: fixed-width composite; commonly 4×u32 (forming two u64) + trailing u32/u8 flag (akin to 0x0046)

Schema Walk (BuildArgs VM; first pass)
Notes:
- 0x11 → array count (u8), followed by that many element blocks defined inline
- 0x12 → array count (u16), followed by that many elements
- 0x17 → u32 scalar
- 0x13 → fixed-size bytes (len from schema)
- 0x14/0x15 → len-u8/len-u16 prefixed blob

Observed for &DAT_1425140E0 (inferred):
1) [container key] — pointer-like (emitted as an address in the tuple, consumed by FUN_140257E70); realized via a composite or fixed bytes (0x13/0x0C).
2) [array] — typecode 0x11 or 0x12:
   - count: u8 or u16
   - element schema:
     • Four successive 0x17 (a0..a3) forming two u64s when packed
     • One trailing 0x17 (flag) or 0x02 (u8 flag), written to a flag/enable lane

Exact confirmation of 0x11 vs 0x12 and element stride should be made by looking at &DAT_1425140E0’s typecodes directly and matching handler copy sizes (e.g., 16-byte copies imply 4×u32; an extra 4 bytes implies trailing u32).

Finalized Wire Structure (precise typedef once typecodes are read)

```cpp
#pragma pack(push, 1)

struct Smsg_0041_Tuple {
    // Container resolution key (as used by FUN_140257E70); shape depends on schema head
    void*      container_key;  // if pointer-based; or a small composite if 0x13/0x0C is used

    // Array (count width determined by 0x11 vs 0x12)
    uint16_t   elem_count;     // set to uint8_t if schema uses 0x11
    struct Elem {
        // Element material consumed by the installer/refresh helper
        uint32_t a0;           // low part for u64_0
        uint32_t a1;           // high part for u64_0
        uint32_t a2;           // low part for u64_1
        uint32_t a3;           // high part for u64_1
        uint32_t flag;         // presence/enable/metadata; set to uint8_t if schema uses 0x02 here
    } *elems;
};

#pragma pack(pop)
```

Handler–Field Correlation
- container_key → used in FUN_140257E70/FUN_1402541C0 to resolve/create tbl at param_1 + 0x128
- For each element:
  • (a0..a3) → packed into two u64 lanes or copied in a 16-byte write into the record
  • flag → written to a side lane (u32/u8) to mark presence/behavior
- If present, a parallel metadata field (e.g., +0x14 lane) is updated from a value derived during the element install (like a classification or index).

Validation Notes
- Confirm count width by reading &DAT_1425140E0 head (0x11 vs 0x12).
- Confirm element size by handler copy patterns: 16-byte copy + trailing scalar write implies 20-byte element.
- If any optional blobs are present (0x14/0x15), they typically accompany elements as secondary material; none required by the observed install path.

Revision Plan
- After verifying typecodes for &DAT_1425140E0, adjust elem_count type (u8/u16) and flag width (u8/u32) and mark struct “final.”
